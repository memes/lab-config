# Vault provisioning

This folder contains Terraform to configure Vault for Accelerated GCP lab. When
applied, Terraform will create resources that define the behaviour of Vault, but
not actual secrets or tokens.

* &#x2713; Authentication methods
* &#x2713; Policies
* &#x2713; AppRoles
* &#x2717; Certificates (except intermediate)
* &#x2717; User/service tokens

> NOTE: This script will need to run as `root` or other privileged account.

## Unsealing - reminder!

```shell
base64 -d <<EOF | gpg -dq; echo
UNSEAL KEY HERE
EOF
vault operator unseal
```

## Login

```shell
./root-otp-login.sh UNSEAL_KEY
```

## Bootstrapping

1. Install Vault and run with TLS disabled

   ```shell
   ansible-playbook -i inventory vault.yml vault
   ```

1. Initialise Vault

   1. Initialise with GPG using 1 key as threshold

      ```shell
      gpg --armor --export 757446333D3EC29A > emes.asc
      export VAULT_ADDR=http://vault.lab.acceleratedgcp.com:8200
      vault operator init -tls-skip-verify -key-shares=1 -key-threshold=1 -pgp-keys=emes.asc
      rm -f emes.asc
      ```

   1. Unseal Vault

      ```shell
      base64 -d <<EOF | gpg -dq; echo
      UNSEAL KEY HERE
      EOF
      vault operator unseal -tls-skip-verify
      ```

   1. Generate OTP for root

      ```shell
      VAULT_SKIP_VERIFY=true ./root-otp-login.sh UNSEAL_KEY
      ```

   1. Execute Terraform to provision Vault pki for CA

      ```shell
      VAULT_SKIP_VERIFY=true terraform init
      VAULT_SKIP_VERIFY=true terraform apply \
         -target vault_mount.pki_ca \
         -auto-approve
      ```

   1. Load the externally generated CA cert and key bundle

      ```shell
      vault write -tls-skip-verify pki_ca/config/ca pem_bundle=@path/to/ca_bundle.pem
      ```

   1. Provision the remaining Vault policies, roles, etc.

      ```shell
      VAULT_SKIP_VERIFY=true terraform apply -auto-approve

1. Enable TLS for Vault

   1. Regenerate Vault certificate

      ```shell
      make clean vault.lab.acceleratedgcp.com.pem
      ```

   1. Revoke current root OTP token

      ```shell
         vault token lookup -tls-skip-verify
         vault token revoke -tls-skip-verify OTP_ROOT_TOKEN
      ```

   1. Rotate the Vault certificate and restart service

      ```shell
      ansible-playbook -i inventory vault.yml
      ```

   1. Launch a new shell or reset VAULT_ADDR environment to use TLS

      ```shell
      export VAULT_ADDR=https://vault.lab.acceleratedgcp.com:8200
      ```

   Vault should now be running with TLS certs generated by Vault itself; at this point it can be unsealed, and used with OIDC tokens.

<!-- markdownlint-disable MD033 MD034 -->
<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|:----:|:-----:|:-----:|
| person\_domains | The list of domains that will be permitted for person \(VPN\) CSRs. | list(string) | `[ "home.arpa", "lab.acceleratedgcp.com" ]` | no |
| server\_2048\_domains | The list of domains that will be permitted for server CSRs that must be restricted to 2048 bits \(iDRAC\). | list(string) | `[ "lab.acceleratedgcp.com" ]` | no |
| server\_domains | The list of domains that will be permitted for server CSRs. | list(string) | `[ "home.arpa", "lab.acceleratedgcp.com" ]` | no |

<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
<!-- markdownlint-enable MD033 MD034 -->
